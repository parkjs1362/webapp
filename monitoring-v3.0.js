/**
 * Î™®ÎãàÌÑ∞ÎßÅ Î∞è Î°úÍπÖ ÏãúÏä§ÌÖú (Monitoring & Logging)
 * v3.0.0 Î∞∞Ìè¨ ÌõÑ Ïã§ÏãúÍ∞Ñ Î™®ÎãàÌÑ∞ÎßÅ
 *
 * Í∏∞Îä•:
 * 1. Ïã§ÏãúÍ∞Ñ ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ (Î°úÎìú ÏãúÍ∞Ñ, ÎèôÍ∏∞Ìôî ÏÜçÎèÑ Îì±)
 * 2. ÏóêÎü¨ Ï∂îÏ†Å Î∞è Î°úÍ∑∏ ÏàòÏßë
 * 3. ÏÇ¨Ïö©Ïûê ÌôúÎèô Ï∂îÏ†Å
 * 4. Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù
 * 5. Î©îÌä∏Î¶≠ ÏàòÏßë Î∞è Î¶¨Ìè¨ÌåÖ
 */

class MonitoringSystem {
    constructor() {
        this.metrics = {
            pageLoadTime: 0,
            migrationTime: 0,
            syncTimes: [],
            errors: [],
            events: [],
            userActions: [],
            dataChecks: [],
            startTime: Date.now()
        };

        this.config = {
            enableConsoleLogging: true,
            enableRemoteLogging: false,  // ÎÇòÏ§ëÏóê ÏÑúÎ≤Ñ Ïó∞Îèô Ïãú ÌôúÏÑ±Ìôî
            remoteLoggingUrl: '/api/logs',
            alertThresholds: {
                slowSync: 5000,        // 5Ï¥à Ïù¥ÏÉÅ ÎèôÍ∏∞Ìôî
                highErrorRate: 0.05,   // 5% Ïù¥ÏÉÅ ÏóêÎü¨
                largeStorage: 10 * 1024 * 1024  // 10MB Ïù¥ÏÉÅ
            }
        };

        this.setupGlobalErrorHandler();
        this.setupPerformanceMonitoring();
        console.log('‚úÖ MonitoringSystem initialized');
    }

    // ========================================================================
    // Ï†ÑÏó≠ ÏóêÎü¨ Ìï∏Îì§Îü¨
    // ========================================================================

    setupGlobalErrorHandler() {
        // JavaScript ÏóêÎü¨ Ï∫êÏπò
        window.addEventListener('error', (event) => {
            this.logError({
                type: 'javascript',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack,
                timestamp: Date.now()
            });
        });

        // Promise rejection Ï∫êÏπò
        window.addEventListener('unhandledrejection', (event) => {
            this.logError({
                type: 'unhandledPromiseRejection',
                message: event.reason?.message || event.reason,
                stack: event.reason?.stack,
                timestamp: Date.now()
            });
        });

        console.log('‚úÖ Global error handler setup completed');
    }

    // ========================================================================
    // ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ
    // ========================================================================

    setupPerformanceMonitoring() {
        // ÌéòÏù¥ÏßÄ Î°úÎìú ÏãúÍ∞Ñ Ï∏°Ï†ï
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                this.metrics.pageLoadTime = Date.now() - this.metrics.startTime;
                console.log(`‚è±Ô∏è  Page load time: ${this.metrics.pageLoadTime}ms`);
            });
        } else {
            this.metrics.pageLoadTime = Date.now() - this.metrics.startTime;
        }

        // v3 Ï¥àÍ∏∞Ìôî ÏãúÍ∞Ñ Î™®ÎãàÌÑ∞ÎßÅÏùÑ ÏúÑÌï¥ ÌõÑÌÇπ
        const originalInitializeV3 = window.initializeV3;
        if (originalInitializeV3) {
            window.initializeV3 = () => {
                const start = performance.now();
                const result = originalInitializeV3();
                const duration = performance.now() - start;

                this.metrics.migrationTime = duration;
                this.logMetric('v3.initialization', duration);
                console.log(`‚è±Ô∏è  v3.0.0 initialization time: ${duration.toFixed(2)}ms`);

                return result;
            };
        }
    }

    // ========================================================================
    // ÎèôÍ∏∞Ìôî Î™®ÎãàÌÑ∞ÎßÅ
    // ========================================================================

    /**
     * ÎèôÍ∏∞Ìôî ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ
     */
    monitorSync(syncStart, syncEnd, syncData) {
        const duration = syncEnd - syncStart;
        this.metrics.syncTimes.push({
            timestamp: syncStart,
            duration: duration,
            size: syncData ? JSON.stringify(syncData).length : 0
        });

        // ÎäêÎ¶∞ ÎèôÍ∏∞Ìôî Í∞êÏßÄ
        if (duration > this.config.alertThresholds.slowSync) {
            this.logWarning({
                type: 'slowSync',
                duration: duration,
                threshold: this.config.alertThresholds.slowSync,
                message: `‚ö†Ô∏è Slow synchronization detected: ${duration}ms`
            });
        }

        this.logMetric('sync.duration', duration);
        return {
            success: true,
            duration: duration,
            averageSyncTime: this.getAverageSyncTime()
        };
    }

    getAverageSyncTime() {
        if (this.metrics.syncTimes.length === 0) return 0;
        const total = this.metrics.syncTimes.reduce((sum, s) => sum + s.duration, 0);
        return total / this.metrics.syncTimes.length;
    }

    // ========================================================================
    // ÏóêÎü¨ Ï∂îÏ†Å
    // ========================================================================

    /**
     * ÏóêÎü¨ Î°úÍπÖ
     */
    logError(errorData) {
        this.metrics.errors.push({
            ...errorData,
            timestamp: Date.now(),
            url: window.location.href
        });

        if (this.config.enableConsoleLogging) {
            console.error('‚ùå Error logged:', errorData);
        }

        // ÏóêÎü¨Ïú® Ï≤¥ÌÅ¨
        this.checkErrorRate();

        // ÏõêÍ≤© Î°úÍπÖ (ÌïÑÏöîÏãú)
        if (this.config.enableRemoteLogging) {
            this.sendToRemote('error', errorData);
        }
    }

    /**
     * Í≤ΩÍ≥† Î°úÍπÖ
     */
    logWarning(warningData) {
        this.metrics.events.push({
            type: 'warning',
            ...warningData,
            timestamp: Date.now()
        });

        if (this.config.enableConsoleLogging) {
            console.warn('‚ö†Ô∏è  Warning:', warningData);
        }
    }

    /**
     * Î©îÌä∏Î¶≠ Î°úÍπÖ
     */
    logMetric(name, value) {
        this.metrics.events.push({
            type: 'metric',
            name: name,
            value: value,
            timestamp: Date.now()
        });
    }

    /**
     * ÏÇ¨Ïö©Ïûê ÌôúÎèô Ï∂îÏ†Å
     */
    trackUserAction(action, details = {}) {
        this.metrics.userActions.push({
            action: action,
            details: details,
            timestamp: Date.now()
        });

        console.log(`üìå User action: ${action}`, details);
    }

    // ========================================================================
    // Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù
    // ========================================================================

    /**
     * v3 Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
     */
    validateV3Data(v3Data) {
        const issues = [];

        if (!v3Data) {
            issues.push('v3Data is null or undefined');
            return { valid: false, issues };
        }

        // ÌïÑÏàò ÌïÑÎìú ÌôïÏù∏
        const requiredFields = [
            'user', 'metadata', 'studyPlans', 'subjects',
            'timeBlocks', 'studyLogs', 'mockExams', 'learningHistory'
        ];

        requiredFields.forEach(field => {
            if (!v3Data[field]) {
                issues.push(`Missing field: ${field}`);
            }
        });

        // Î∞∞Ïó¥ Í≤ÄÏ¶ù
        if (!Array.isArray(v3Data.studyPlans)) issues.push('studyPlans is not an array');
        if (!Array.isArray(v3Data.subjects)) issues.push('subjects is not an array');
        if (!Array.isArray(v3Data.timeBlocks)) issues.push('timeBlocks is not an array');
        if (!Array.isArray(v3Data.studyLogs)) issues.push('studyLogs is not an array');

        // Ï†ÄÏû•ÏÜå ÌÅ¨Í∏∞ Í≤ÄÏ¶ù
        const size = JSON.stringify(v3Data).length;
        if (size > this.config.alertThresholds.largeStorage) {
            issues.push(`Storage size too large: ${(size / 1024 / 1024).toFixed(2)}MB`);
        }

        // Ï∞∏Ï°∞ Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù
        v3Data.timeBlocks?.forEach((block, idx) => {
            if (block.userId && !v3Data.user) {
                issues.push(`TimeBlock[${idx}] references non-existent user`);
            }
        });

        const isValid = issues.length === 0;
        this.metrics.dataChecks.push({
            timestamp: Date.now(),
            valid: isValid,
            issues: issues,
            dataSize: size
        });

        return { valid: isValid, issues };
    }

    /**
     * ÏóêÎü¨Ïú® Ï≤¥ÌÅ¨
     */
    checkErrorRate() {
        const recentWindow = 5 * 60 * 1000;  // ÏµúÍ∑º 5Î∂Ñ
        const now = Date.now();
        const recentErrors = this.metrics.errors.filter(
            e => now - e.timestamp < recentWindow
        );

        const errorRate = recentErrors.length / 60;  // Î∂ÑÎãπ ÏóêÎü¨

        if (errorRate > this.config.alertThresholds.highErrorRate) {
            this.logWarning({
                type: 'highErrorRate',
                rate: errorRate,
                errors: recentErrors.length,
                message: `‚ö†Ô∏è High error rate detected: ${(errorRate * 100).toFixed(2)}% in last 5 minutes`
            });
        }
    }

    // ========================================================================
    // Î¶¨Ìè¨ÌåÖ
    // ========================================================================

    /**
     * ÏÑ±Îä• Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
     */
    generatePerformanceReport() {
        const now = Date.now();
        const uptime = now - this.metrics.startTime;

        return {
            timestamp: now,
            uptime: `${(uptime / 1000 / 60).toFixed(2)}Î∂Ñ`,
            pageLoadTime: `${this.metrics.pageLoadTime}ms`,
            v3InitTime: `${this.metrics.migrationTime.toFixed(2)}ms`,
            avgSyncTime: `${this.getAverageSyncTime().toFixed(2)}ms`,
            totalSyncs: this.metrics.syncTimes.length,
            totalErrors: this.metrics.errors.length,
            totalActions: this.metrics.userActions.length,
            lastDataCheck: this.getLastDataCheck(),
            health: this.calculateHealth()
        };
    }

    /**
     * ÏµúÍ∑º Îç∞Ïù¥ÌÑ∞ Ï≤¥ÌÅ¨ Í≤∞Í≥º
     */
    getLastDataCheck() {
        if (this.metrics.dataChecks.length === 0) return null;
        const latest = this.metrics.dataChecks[this.metrics.dataChecks.length - 1];
        return {
            timestamp: new Date(latest.timestamp).toLocaleString(),
            valid: latest.valid,
            issues: latest.issues.length,
            dataSize: `${(latest.dataSize / 1024).toFixed(2)}KB`
        };
    }

    /**
     * ÏãúÏä§ÌÖú ÏÉÅÌÉú Í≥ÑÏÇ∞
     */
    calculateHealth() {
        const errorScore = Math.max(0, 100 - (this.metrics.errors.length * 5));
        const performanceScore = this.getPerformanceScore();
        const dataScore = this.getDataIntegrityScore();

        const overall = (errorScore + performanceScore + dataScore) / 3;

        return {
            overall: Math.round(overall),
            error: Math.round(errorScore),
            performance: Math.round(performanceScore),
            data: Math.round(dataScore),
            status: overall > 80 ? '‚úÖ Good' : overall > 50 ? '‚ö†Ô∏è Fair' : '‚ùå Poor'
        };
    }

    /**
     * ÏÑ±Îä• Ï†êÏàò Í≥ÑÏÇ∞
     */
    getPerformanceScore() {
        const avgSyncTime = this.getAverageSyncTime();
        const threshold = this.config.alertThresholds.slowSync;

        if (avgSyncTime < threshold * 0.5) return 100;
        if (avgSyncTime < threshold) return 80;
        if (avgSyncTime < threshold * 2) return 60;
        return 40;
    }

    /**
     * Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Ï†êÏàò
     */
    getDataIntegrityScore() {
        if (this.metrics.dataChecks.length === 0) return 50;

        const validChecks = this.metrics.dataChecks.filter(c => c.valid).length;
        return (validChecks / this.metrics.dataChecks.length) * 100;
    }

    /**
     * ÏÉÅÏÑ∏ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
     */
    generateDetailedReport() {
        return {
            summary: {
                timestamp: new Date().toLocaleString(),
                systemHealth: this.calculateHealth(),
                uptime: this.metrics.startTime
            },
            performance: {
                pageLoadTime: this.metrics.pageLoadTime,
                v3InitTime: this.metrics.migrationTime,
                avgSyncTime: this.getAverageSyncTime(),
                totalSyncs: this.metrics.syncTimes.length,
                syncTimeSeries: this.metrics.syncTimes.slice(-10)  // ÏµúÍ∑º 10Í∞ú
            },
            errors: {
                total: this.metrics.errors.length,
                recent: this.metrics.errors.slice(-5),
                byType: this.groupErrorsByType()
            },
            userActions: {
                total: this.metrics.userActions.length,
                recent: this.metrics.userActions.slice(-10),
                byAction: this.groupActionsByType()
            },
            dataHealth: {
                checks: this.metrics.dataChecks.length,
                valid: this.metrics.dataChecks.filter(c => c.valid).length,
                recent: this.metrics.dataChecks.slice(-3)
            }
        };
    }

    /**
     * ÏóêÎü¨Î•º ÌÉÄÏûÖÎ≥ÑÎ°ú Í∑∏Î£πÌôî
     */
    groupErrorsByType() {
        const grouped = {};
        this.metrics.errors.forEach(error => {
            const type = error.type || 'unknown';
            grouped[type] = (grouped[type] || 0) + 1;
        });
        return grouped;
    }

    /**
     * Ïï°ÏÖòÏùÑ ÌÉÄÏûÖÎ≥ÑÎ°ú Í∑∏Î£πÌôî
     */
    groupActionsByType() {
        const grouped = {};
        this.metrics.userActions.forEach(action => {
            const type = action.action || 'unknown';
            grouped[type] = (grouped[type] || 0) + 1;
        });
        return grouped;
    }

    // ========================================================================
    // ÏõêÍ≤© Î°úÍπÖ (Ìñ•ÌõÑ Íµ¨ÌòÑ)
    // ========================================================================

    /**
     * ÏõêÍ≤© ÏÑúÎ≤ÑÎ°ú Î°úÍ∑∏ Ï†ÑÏÜ°
     */
    sendToRemote(type, data) {
        if (!this.config.enableRemoteLogging) return;

        try {
            fetch(this.config.remoteLoggingUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: type,
                    data: data,
                    timestamp: Date.now(),
                    url: window.location.href
                })
            }).catch(err => {
                console.warn('Failed to send logs to remote:', err);
            });
        } catch (error) {
            console.error('Error sending to remote:', error);
        }
    }

    /**
     * Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Î¶¨Ìè¨Ìä∏ Ï†ÑÏÜ°
     */
    startPeriodicReporting(interval = 5 * 60 * 1000) {  // Í∏∞Î≥∏ 5Î∂Ñ
        setInterval(() => {
            const report = this.generatePerformanceReport();
            console.log('üìä Periodic Report:', report);

            if (this.config.enableRemoteLogging) {
                this.sendToRemote('periodicReport', report);
            }
        }, interval);
    }

    // ========================================================================
    // ÏΩòÏÜî ÌëúÏãú
    // ========================================================================

    /**
     * ÏΩòÏÜîÏóê Î¶¨Ìè¨Ìä∏ Ï∂úÎ†•
     */
    printReport() {
        const report = this.generatePerformanceReport();
        console.group('üìä v3.0.0 Performance Report');
        console.table(report);
        console.groupEnd();

        const detailed = this.generateDetailedReport();
        console.group('üìã Detailed Report');
        console.log(detailed);
        console.groupEnd();
    }

    /**
     * ÏãúÏä§ÌÖú Ìó¨Ïä§ Ï≤¥ÌÅ¨ UI ÏÉùÏÑ±
     */
    createHealthCheckUI() {
        const health = this.calculateHealth();
        const statusColor = health.overall > 80 ? '#34c759' : health.overall > 50 ? '#ff9500' : '#ff3b30';

        return `
        <div style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 2px solid ${statusColor};
            border-radius: 12px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            max-width: 300px;
        ">
            <div style="font-weight: bold; margin-bottom: 10px;">
                üè• System Health ${health.status}
            </div>
            <div style="margin-bottom: 8px;">
                Overall: <strong>${health.overall}/100</strong>
            </div>
            <div style="margin-bottom: 4px;">
                Errors: <strong>${this.metrics.errors.length}</strong>
            </div>
            <div style="margin-bottom: 4px;">
                Syncs: <strong>${this.metrics.syncTimes.length}</strong>
            </div>
            <div style="margin-bottom: 4px;">
                Avg Sync: <strong>${this.getAverageSyncTime().toFixed(0)}ms</strong>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                <button onclick="window.monitoring.printReport()" style="
                    background: ${statusColor};
                    color: white;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 4px;
                    cursor: pointer;
                    width: 100%;
                ">ÏÉÅÏÑ∏ Î¶¨Ìè¨Ìä∏</button>
            </div>
        </div>
        `;
    }
}

// ============================================================================
// Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
// ============================================================================

let monitoring = null;

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        monitoring = new MonitoringSystem();
        console.log('‚úÖ Monitoring system ready');
    });
} else {
    monitoring = new MonitoringSystem();
    console.log('‚úÖ Monitoring system ready');
}

// Ï†ÑÏó≠ ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§Ïóê ÎÖ∏Ï∂ú
window.MonitoringSystem = MonitoringSystem;
window.monitoring = monitoring;

console.log('‚úÖ Monitoring Module loaded');
